<?php
namespace Ibnab\CategoriesSide\Observer\Product;

use Magento\Framework\Event\ObserverInterface;
use Magento\Framework\App\RequestInterface;



class AddProduct implements ObserverInterface
{
    
   
    protected $_productRepository;
    protected $_cart;
    // protected $_checkoutSession;
    protected $_cookieManager;
    protected $_cookieMetadataFactory;
    protected $customOptionRepository;



    public function __construct(\Magento\Catalog\Model\ProductRepository $productRepository, \Magento\Checkout\Model\Cart $cart ,\Magento\Framework\Stdlib\CookieManagerInterface $cookieManager,
    \Magento\Framework\Stdlib\Cookie\CookieMetadataFactory $cookieMetadataFactory,\Magento\Catalog\Api\ProductCustomOptionRepositoryInterface $customOptionRepository ){
        $this->_productRepository = $productRepository;
        $this->_cart = $cart;
        // $this->_checkoutSession = $checkoutSession;
        $this->_cookieManger = $cookieManager;
        $this->_cookieMetadataFactory = $cookieMetadataFactory;
        $this->customOptionRepository = $customOptionRepository;

    }

    public function execute(\Magento\Framework\Event\Observer $observer)
    {
        $writer = new \Zend_Log_Writer_Stream(BP . '/var/log/custom.log');
    $logger = new \Zend_Log();
   $logger->addWriter($writer);
       
        $item=$observer->getEvent()->getData('quote_item');
        $product=$observer->getEvent()->getData('product');
    //     // $item = ( $item->getParentItem() ? $item->getParentItem() : $item );
        $product->getQty();

      
        
        $id=$this->_cookieManger->getCookie('id');
        $customopt=$this->_cookieManger->getCookie('customopt');
        $customopt=json_decode($customopt);
        
        // $customopt=stripslashes($customopt);
        $customoptArray = explode (",", $customopt);
        
        // foreach($customoptArray as $value){
        // $logger->info("asdasdasdasd ".$value);
        // }
        // die('');
        // $objectManager = \Magento\Framework\App\ObjectManager::getInstance();
        // $product = $objectManager->create('\Magento\Catalog\Model\Product')->load($id);
        $_product = $this->_productRepository->getById($id);

    
   $count=0;
   $logger->info('Product Name '.$_product->getName());
    foreach ($_product->getOptions() as $o) 
    {     

        foreach ($o->getValues() as $value) 
        {
            foreach($customoptArray as $customopt){

                $customoptArrayValue = trim($customopt, "[");
                $customoptArrayValue = trim($customoptArrayValue , "]");
                $logger->info($customoptArrayValue);

                $customoptArrayValue = str_replace('"', '', $customoptArrayValue);;
                
                if ($value['title'] == $customoptArrayValue ){
                    $logger->info('Value title is '.$value['title'].'After trim '.$customoptArrayValue.' Option id is '.$value['option_id']);
                    // $logger->info();
                    // $logger->info('Option type id '.$value['option_type_id']);
                    $options[$value['option_id']] = $value['option_type_id'];
                }
            }
            
            // $logger->info(print_r($value, true));
            
    
        }           
    }
    $logger->info($count);

    $params = array();
    $logger->info($options);
    $params['qty'] = 1;
    $params['options'] = $options;
    $logger->info(print_r($params, true));
        $this->_cart->addProduct($_product, $params);
        $this->_cart->save();

    }
   
}
